# 浏览器相关

作为前端开发人员，我们总是沉迷于各种前端框架，对于浏览器，我们大部分时候只是作为一个“测试工具”，我认为，浏览器的相关知识能够帮助我们更好的去开发，去了解到浏览器的原理，能让我们更好的去做优化和测试。

首先看一下浏览器的工作流程：

1. 浏览器使用 HTTP（s）协议向服务端请求页面
2. 将 HTML 解析，构造成 DOM 树
3. 计算 DOM 树上的 CSS 属性
4. 根据 CSS 对元素进行渲染，得到内存中的位图
5. 可选步骤：对位图进行渲染（极大增加后续渲染速度）
6. 绘制到界面上

## 解析 HTML 代码

要解析 HTML 代码，少不了计算机编译原理的知识，当浏览器拿到 HTTP 的Response 的 body 部分后，便开始处理。

### 1. 词的拆分

HTML 会被拆分成 token，也就是词，这一步叫**词法分析**，一段简单的代码来查看这一过程。

```html
<p class="text">This is a text.</p>
```

这段代码可以解析成以下几个部分：

- <p：标签的开始
- class="text"：属性
- \>: 标签开始的结束
- This is a text.：文本
- <\/p>：标签的结束

这些 token 是如何判断的呢，怎么知道 "<" 就是一个开始符号，而不是其他。将字符流转化为 token，这就需要由状态机来实现的。

### 2. 状态机

大部分语言的词法分析都是由状态机来实现，[HTML官方文档](https://html.spec.whatwg.org/multipage/parsing.html#tokenization)中规定了80个状态（对大部分语言来说，状态机是一种实现而非定义，而html有相关的定义文档）。

用状态机做词法分析，其实是把每个词的”特征字符“逐个拆分成独立状态，再合并起来，形成一个连通图结构

 
## 构建 DOM 树

将字符流转化为 token 后，下一步就是将简单的构建成 DOM 树，这个过程使用栈来实现，这一步涉及到的是语法分析，根据一些编译原理中常见的技巧，我们使用的栈正是用于匹配开始和结束标签的方案。

标签的开始和标签的结束需要成对比配。对于 Text 节点，我们则需要把相邻的 Text 节点合并起来，我们的做法是当词（token）入栈时，检查栈顶是否是 Text 节点，如果是的话就合并 Text 节点

通过栈，可以这样构建一个 DOM 树

- 栈顶元素就是当前节点
- 遇到属性就添加到当前节点
- 遇到文本节点，如果当前节点是文本节点，则合并，否则入栈成为当前节点的子节点
- 遇到注释节点，成为当前节点的子节点
- 遇到 tag start 就入栈一个节点，当前节点就是这个节点的父节点
- 遇到 tag end 就出栈一个节点

在构建 DOM 树的过程中，依次拿到构造好的元素，去检查元素匹配到哪些规则，根据规则的优先级，做调整，我们常说的选择器，应该被称为”匹配器“更为合适。

CSS同样需要经过词法分析和语法分析，解析成CSSOM树。

## 排版

当计算好 CSS 属性后，浏览器需要确定每个元素的位置，这个过程叫做排版。浏览器最基本的排版方案是**正常流排版**。而文字的排版有一套文字排版规范，文字排版是一个复杂的系统，它规定了行模型和文字在行模型中的排布。

元素和文字可以混合排版，元素被定义为占据长方形的区域，还允许边框、边距和留白，这个就是所谓的盒模型。

在正常流的基础上，浏览器支持两类特殊元素：绝对定位和浮动元素，除了正常流，浏览器还支持其他的排版方式，如 flex 布局，这些排版方式由外部元素 display 来控制。
